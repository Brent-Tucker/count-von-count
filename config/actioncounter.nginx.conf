init_by_lua_file "action-counter/lib/init.lua";
server {
    listen 80;
    location /lua-redis-check {
    	default_type text/html;
    	content_by_lua '
			local redis = require "resty.redis"
            local red = redis:new()
            local ok, err = red:connect("127.0.0.1", 6379)
            if not ok then
                ngx.say("failed to connect: ", err)
                return
            end

            ok, err = red:eval("local actionCounter = 1; return actionCounter", 0)
            if not ok then
                ngx.say("failed to set data: ", err)
                return
            end

            ngx.say("set result: ", ok)
    	';
    }

    include       vars.conf;

    location = /favicon.ico {
        empty_gif;
    }
    
    location = /robots.txt {
        empty_gif;
    }

    location ~ /_.gif {
        empty_gif;
    }

    location ~ /get {
        default_type text/html;
        content_by_lua_file "action-counter/lib/get.lua";
    }

    location ~ /(.*) {
        set $action $1;
        content_by_lua_file "action-counter/lib/redis_hook.lua";
    }
}
